/*! Mapkick.js v0.2.5 | MIT License */
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):(t="undefined"!=typeof globalThis?globalThis:t||self).Mapkick=e()}(this,(function(){"use strict";function t(t){if(!/^#([0-9a-f]{3}){1,2}$/i.test(t)&&!/^[a-z]+$/i.test(t))throw new Error("Invalid color")}var e={},o=function(o,n,r,a){var s=this;i.library||"undefined"==typeof window||(i.library=window.mapboxgl||window.maplibregl||null);var c,l=i.library;if(!l)throw new Error("No mapping library found");var p={},u={},f=[],d=0;function y(t){c.loaded()?t():c.on("load",t)}function m(t){return"number"==typeof t?t:new Date(t).getTime()/1e3}function h(t,e){d++,k(t,u[f[d]],e),d<f.length-1&&setTimeout((function(){h(t,e)}),100)}function v(t,e){t.textContent=e}function g(t,e,o,n){try{n(t,e,o)}catch(e){throw v(t,e.message),e}}function w(t,e,o,n){"string"==typeof e?function(t,e,o){var n=new XMLHttpRequest;n.open("GET",e,!0),n.setRequestHeader("Content-Type","application/json"),n.onload=function(){200===n.status?o(JSON.parse(n.responseText)):v(t,n.statusText)},n.send()}(t,e,(function(e){g(t,e,o,n)})):"function"==typeof e?e((function(e){g(t,e,o,n)}),(function(e){v(t,e)})):g(t,e,o,n)}function k(t,e,o){var n;n=function(){o.trail&&(E(e,o.trail),c.getSource("trails").setData(L(e))),c.getSource("objects").setData(x(e,o))},O?n():S.push(n)}(o=function(t){if("string"==typeof t){var e=t;if(!(t=document.getElementById(t)))throw new Error("No element with id "+e)}return t}(o)).id&&(e[o.id]=this);var b=new window.Map;function x(e,o){for(var n={type:"FeatureCollection",features:[]},r=0;r<e.length;r++){var i=e[r],s=Object.assign({},i),c=void 0;if("point"===a){if(s.icon||(s.icon=o.defaultIcon||"mapkick"),s.mapkickIconSize="mapkick"===s.icon?.5:1,s.mapkickIconAnchor="mapkick"===s.icon?"bottom":"center",s.mapkickIconOffset="mapkick"===s.icon?[0,10]:[0,0],"mapkick"===s.icon){var l=s.color||_.color||"#f84d4d",p=b.get(l);void 0===p&&(p=b.size,t(l),b.set(l,p)),s.icon="mapkick-"+p}var u=C(i);if(!u[1])throw new Error("missing latitude (index: "+r+")");if(!u[0])throw new Error("missing longitude (index: "+r+")");c={type:"Point",coordinates:u}}else{if(!(c=i.geometry))throw new Error("missing geometry (index: "+r+")");delete s.geometry,s.mapkickColor=s.color||_.color||"#0090ff"}n.features.push({type:"Feature",id:r,geometry:c,properties:s})}return n}function C(t){return[t.longitude||t.lng||t.lon,t.latitude||t.lat]}function I(t){return t.id}function E(t,e){for(var o=0;o<t.length;o++){var n=t[o],r=I(n);p[r]||(p[r]=[]),p[r].push(C(n)),e&&e.len&&p[r].length>e.len&&p[r].shift()}}function L(t){for(var e={type:"FeatureCollection",features:[]},o=0;o<t.length;o++){var n=t[o];e.features.push({type:"Feature",geometry:{type:"LineString",coordinates:p[I(n)]}})}return e}function M(t,e){var o={};if(c.addSource(t,{type:"geojson",data:e}),"point"===a)c.addLayer({id:t+"-text",source:t,type:"symbol",layout:{"text-field":"{label}","text-size":11,"text-anchor":"top","text-offset":[0,1]},paint:{"text-halo-color":"rgba(255, 255, 255, 1)","text-halo-width":1}}),c.addLayer({id:t,source:t,type:"symbol",layout:{"icon-image":"{icon}-15","icon-allow-overlap":!0,"icon-size":{type:"identity",property:"mapkickIconSize"},"icon-anchor":{type:"identity",property:"mapkickIconAnchor"},"icon-offset":{type:"identity",property:"mapkickIconOffset"}}});else{var n=function(t){for(var e,o=t.getStyle().layers,n=o.length-1;n>=0;n--){var r=o[n];if(!r.metadata||"place-labels"!==r.metadata["mapbox:featureComponent"])break;e=r.id}return e}(c),r=t+"-outline";c.addLayer({id:r,source:t,type:"line",paint:{"line-color":{type:"identity",property:"mapkickColor"},"line-opacity":.7,"line-width":1}},n),c.addLayer({id:t,source:t,type:"fill",paint:{"fill-color":{type:"identity",property:"mapkickColor"},"fill-opacity":.3}},r);for(var i=t+"-text",s=function(t){for(var e={type:"FeatureCollection",features:[]},o=0;o<t.features.length;o++){var n=t.features[o],r=void 0,i=new l.LngLatBounds;if(T(i,n.geometry),!i.isEmpty()){var a=i.getCenter();r=[a.lng,a.lat]}r&&e.features.push({type:"Feature",id:o,geometry:{type:"Point",coordinates:r},properties:n.properties})}return e}(e),p=0;p<s.features.length;p++){var u=s.features[p];o[u.id]=u.geometry.coordinates}c.addSource(i,{type:"geojson",data:s}),c.addLayer({id:t+"-text",source:i,type:"symbol",layout:{"text-field":"{label}","text-size":11},paint:{"text-halo-color":"rgba(255, 255, 255, 1)","text-halo-width":1}})}var f=!("hover"in A)||A.hover,d={closeButton:!1,closeOnClick:!1};f||(d.anchor="bottom");var y=new l.Popup(d),m=function(t){var e,n=v(t),r=n.properties.tooltip;r&&("point"===a&&n.properties.icon.startsWith("mapkick-")?y.options.offset={top:[0,14],"top-left":[0,14],"top-right":[0,14],bottom:[0,-44],"bottom-left":[0,-44],"bottom-right":[0,-44],left:[14,0],right:[-14,0]}:y.options.offset=14,e="point"===a?n.geometry.coordinates:o[n.id],y.setLngLat(e),A.html?y.setHTML(r):y.setText(r),y.addTo(c),y._container.offsetWidth%2!=0&&(y._container.style.width=y._container.offsetWidth+1+"px"),"area"!==a&&function(t,e){var o=window.getComputedStyle(e.getElement()),n=new DOMMatrixReadOnly(o.transform),r=n.m42,i=n.m41;(r<5||i<5)&&t.panBy([Math.min(i-5-5,0),Math.min(r-5-5,0)])}(c,y))},h=function(t){return t.geometry.coordinates[1]},v=function(t){for(var e=t.features,o=e[0],n=1;n<e.length;n++){var r=e[n];h(r)<h(o)&&(o=r)}return o};if(!f){var g=null;c.on("click",t,(function(t){var e=v(t).id;e!==g&&(m(t),g=e,t.mapkickPopupOpened=!0)})),c.on("click",(function(t){t.mapkickPopupOpened||(y.remove(),g=null)}))}c.on("mouseenter",t,(function(t){v(t).properties.tooltip&&(c.getCanvas().style.cursor="pointer",f&&m(t))})),c.on("mouseleave",t,(function(){c.getCanvas().style.cursor="",f&&y.remove()}))}function T(t,e){if("Point"===e.type)t.extend(e.coordinates);else if("Polygon"===e.type)for(var o=e.coordinates[0],n=0;n<o.length;n++)t.extend(o[n]);else if("MultiPolygon"===e.type)for(var r=e.coordinates,i=0;i<r.length;i++)for(var a=r[i][0],s=0;s<a.length;s++)t.extend(a[s])}var j=function(e,o,n){var r=x(o,n);n=n||{};for(var i=0;i<r.features.length;i++)T(z,r.features[i].geometry);e.textContent="";var a=n.style;if(!a){if(!("accessToken"in l)||/^1\.1[45]/.test(l.version))throw new Error("style required for MapLibre");a="mapbox://styles/mapbox/streets-v12"}var p=n.zoom,u=n.center;u||(z.isEmpty()?(u=[0,0],p||(p=1)):u=z.getCenter());var f={container:e,style:a,dragRotate:!1,touchZoomRotate:!1,center:u,zoom:p||15};n.style||(f.projection="mercator"),n.accessToken&&(f.accessToken=n.accessToken),c=new l.Map(f),n.controls&&c.addControl(new l.NavigationControl({showCompass:!1})),n.zoom||(c.style.stylesheet||(c.style.stylesheet={}),z.isEmpty()||c.fitBounds(z,{padding:40,animate:!1,maxZoom:15})),s.map=c,y((function(){n.trail&&(E(o),c.addSource("trails",{type:"geojson",data:L([])}),c.addLayer({id:"trails",source:"trails",type:"line",layout:{"line-join":"round","line-cap":"round"},paint:{"line-color":"#888","line-width":2}}));var e=b.size;function i(){var t;if(0===e)for(M("objects",r),O=!0;t=S.shift();)t();else e--}b.forEach((function(e,o){var n=function(e,o){var n=(new e.Marker)._element.querySelector("svg");n.removeAttribute("display"),n.setAttribute("xmlns","http://www.w3.org/2000/svg"),n.setAttribute("height",41),n.setAttribute("width",27),n.setAttribute("viewBox","0 0 27 41"),t(o),n.querySelector("*[fill='#3FB1CE']").setAttribute("fill",o);var r=n.querySelectorAll("circle"),i=r[r.length-1];if(1==r.length){var a=i.cloneNode();a.setAttribute("fill","#000000"),a.setAttribute("opacity",.25),i.parentNode.insertBefore(a,i)}i.setAttribute("r",4.5);var s=new Image(54,82);return s.src="data:image/svg+xml;utf8,"+encodeURIComponent(n.outerHTML),s}(l,o);n.addEventListener("load",(function(){c.addImage("mapkick-"+e+"-15",n),i()}))})),i()}))},O=!1,S=[];r=r||{};var A=(r=Object.assign({},i.options,r)).tooltips||{},_=r.markers||{},z=new l.LngLatBounds;r.replay?w(o,n,r,(function(t,e,o){for(var n=0;n<e.length;n++){var r=e[n],i=m(r.time);i&&(u[i]||(u[i]=[]),u[i].push(r),z.extend(C(r)))}for(var a in u)Object.prototype.hasOwnProperty.call(u,a)&&f.push(parseInt(a));f.sort(),j(t,u[f[d]],o),y((function(){setTimeout((function(){h(t,o)}),100)}))})):(w(o,n,r,j),r.refresh&&(this.intervalId=setInterval((function(){w(o,n,r,k)}),1e3*r.refresh)))};o.prototype.getMapObject=function(){return this.map},o.prototype.destroy=function(){this.stopRefresh(),this.map&&(this.map.remove(),this.map=null)},o.prototype.stopRefresh=function(){this.intervalId&&(clearInterval(this.intervalId),this.intervalId=null)};var n=function(t){function e(e,o,n){t.call(this,e,o,n,"point")}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e}(o),r=function(t){function e(e,o,n){t.call(this,e,o,n,"area")}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e}(o),i={Map:n,AreaMap:r,maps:e,options:{},library:null,use:function(t){i.library=t}};return"undefined"==typeof window||window.Mapkick||(window.Mapkick=i,setTimeout((function(){window.dispatchEvent(new Event("mapkick:load"))}),0)),i}));
